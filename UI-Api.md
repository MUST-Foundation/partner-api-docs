# Документация по использованию MUST Widget Api для интеграции Front-End

В данном документе описан процесс взаимодействия с системой с целью выпуска полиса еОСАГО для грузовых ТС

Техническая документация Swagger доступна по адресу: https://api.must.io/swagger

## Схема взаимодействия

Взаимодействие с системой происходит через отправку синхронных и асинхронных запросов в MUST Api.

## Основные шаги процесса

Для выпуска полиса необходимо пройти процесс от начала до конца. Процесс состоит из двух этапов

1. (Этап-1) Получение предварительной стоимости и предварительные проверки на доступность страхования
1. (Этап-2) Оформление заявления о страховании, получение точной стоимости, оплата и выпуск полиса ОСАГО

Внимание! Авторизация требуется для финализации Этапа-1 при инициации Этапа-2

Комплексно процесс состоит из следующих шагов

1. (Этап-1, Шаг-1) Инициация процесса "Прескоринга" по VIN/ГРЗ
1. (Этап-1, Шаг-2) Получение основных полей по ТС вместе с предварительной стоимостью страхования
1. (Этап-1, Шаг-3) Передача уточненных (при необходимости, возможно оставить данные без изменений) данных о Страхователе, Собственнике, Флага использования ТС с прицепом, данных о Диагностической карте
1. (Этап-1, Шаг-4) Ожидание сохранения данных
1. (Этап-1, Шаг-5) Авторизация Страхователя
1. (Этап-1, Шаг-6) Финализация Этапа-1 и переход к Этапу-2


1. (Этап-2, Шаг-1) Инициация процесса "Скоринга" по идентификатору процесса "Прескоринга"
1. (Этап-2, Шаг-2) Ожидание завершения скоринга и получение конечных предложений от разных СК
1. (Этап-2, Шаг-3) Выбор желаемой СК для оформления полиса ОСАГО и подписание Заявления о страховании с помощью ПЭП (Простой электронной подписи)
1. (Этап-2, Шаг-4) Выбор способа оплаты полиса: Оплата картой или Оплата безналичным расчетом
1. (Этап-2, Шаг-5) Ожидание формирования ссылки на оплату / счета на оплату
1. (Этап-2, Шаг-6) Подтверждение оплаты с помощью подгрузки скана Платежного поручения (только для безналичной оплаты полиса)
1. (Этап-2, Шаг-7) Ожидание выпуска полиса и его скачивание

## (Этап-1, Шаг-1) Инициация процесса "Прескоринга" по VIN/ГРЗ

```POST``` ```/api/prescoring/front/init```

Необходимо передать либо ```VIN```, либо ГРЗ (```Plates```)

Получаем в ответ ```prescoringId```

## (Этап-1, Шаг-2) Ожидание завершения скоринга и получение конечных предложений от разных СК

Необходимо инициировать цикл запросов ```GET``` ```/api/prescoring/front/fields/{preScoringId}``` с интервалом в 1 секунду до тех пор, пока флаг в ответе ```isCompleted``` или ```isFaulted``` не будут равны ```true```

## (Этап-1, Шаг-3) Передача уточненных (при необходимости, возможно оставить данные без изменений) данных о Страхователе, Собственнике, Флага использования ТС с прицепом, данных о Диагностической карте

Необходимо инициировать запрос ```POST``` ```/api/prescoring/front/calculate``` с указанием уточненных или "как пришли в предыдущем вызове" полей 

## (Этап-1, Шаг-4) Ожидание сохранения данных

Необходимо инициировать цикл запросов ```GET``` ```/api/prescoring/front/calculate/{preScoringId}``` с интервалом в 1 сек. до тех пор, пока флаг в ответе ```isCompleted``` или ```isFaulted``` не будут равны true

## (Этап-1, Шаг-5) Авторизация в системе

Для продолжения процесса оформления полиса, необходимо сделать авторизацию по номеру телефона

Необходимо инициировать вызов ```POST``` ```/api/auth/otp``` с передачей номера телефона Страхователя, что приведет к отправке кода подтверждения СМС. API возвращает поле ```otpState```

Кода пользователь готов вводит СМС код, необходимо инициировать запрос ```POST``` ```/api/auth/login/jwt``` с передачей номера телефона Страхователя, ```otpState```, ```otp``` = СМС код

В ответе приходит в поле ```token``` - токен Bearer авторизации Страхователя в API MUST. 

Далее его необходимо использовать при каждом обращении в API MUST, передавая в заголовке каждого запроса: ```Authorization: Bearer token```. Токен действует 180 суток с момента выпуска. При истечении срока действия токена необходимо его перевыпустить пройдя процедуру заново.

## (Этап-1, Шаг-6) Финализация Этапа-1 и переход к Этапу-2

Необходимо инициировать запрос ```POST``` ```/api/prescoring/front/apply``` с указанием ```preScoringId```. В ответе в поле ```scoringId``` будет передан идентификатор Скоринга.


## (Этап-2, Шаг-1) Инициация процесса "Скоринга" по идентификатору процесса "Прескоринга"

В рамках текущей реализации MUST API скоринг запустится автоматически, поэтому необходимо перейти сразу в разделу Этап-2, Шаг-2


## (Этап-2, Шаг-2) Ожидание завершения скоринга и получение конечных предложений от разных СК

Необходимо инициировать цикл запросов ```GET``` ```/api/user/scoring/{scoringId}``` с интервалом в 1 секунду до тех пор, пока флаг  в ответе ```isScoringCompleted``` или ```isFailed``` не будут равны ```true```

Если есть флаг ```isFailed === true```, то процесс завершен с ошибкой

Если  есть флаг ```isScoringCompleted === true```, то в поле ```scoringResults``` присутствует список результатов скоринга по разным СК с указанием названия СК (```insuranceCompany```), флага ```isApproved``` (согласован выпуск полиса), ```writtenPremium``` - Премия и тд.

## (Этап-2, Шаг-3) Выбор желаемой СК для оформления полиса ОСАГО и подписание Заявления о страховании с помощью ПЭП (Простой электронной подписи)

Необходимо определить в какой СК будет происходить оформление полиса ОСАГО (происходит на стороне Страхователя)

Когда решение принято, то необходимо подписать Заявление о страховании с помощью ПЭП

Для подписи заявления о страховании необходимо сделать два вызова: 

1. запросить код СМС для подписи - ```POST``` ```/api​/profile​/sign``` ( передав параметры ```context = "osago_ext"```; ```contextDetails``` = json )

1. отправить код из СМС для подписки - ```POST``` ```/api/profile/sign/confirm``` ( передав параметры ```otpState```, ```otp```, ```context = "osago_ext"```, ```contextDetails``` = json )

Состав json для поля contextDetails
```
{
    "plates": "С***КМ750",
    "vin": "WMA06XZZ8GP0*****",
    "policyStartOn": "2021-04-04T08:10:18.021+00:00",
    "isStandardCargo": true,
    "isHighRiskCargo": false,
    "isRestricted": false,
    "hasTrailer": true,
    "driverCount": 0,
    "insuranceCompany": "renaissance",
    "writtenPremium": 17847.29,
    "insurer": {
        "inn": "773144****",
        "kpp": "50310****"
    },
    "owner": {
        "inn": "773144****",
        "kpp": "50310****"
    },
    "technicalInspection": {
        "series": ".",
        "number": "0762600120****",
        "startOn": "2020-09-11T00:00:00Z",
        "endOn": "2021-09-30T21:00:00Z"
    }
}
```

## (Этап-2, Шаг-4) Выбор способа оплаты полиса: Оплата картой или Оплата безналичным расчетом

Для оплаты картой нужно сделать запрос ```POST``` ```/api/user/scoring/{scoringId}/payment-link```

Для оплаты по безналу по счету нужно сделать запрос ```POST``` ```/api/user/scoring/{scoringId}/payment-invoice``` 

В рамках обоих запросов передается поле ```insuranceCompany``` с указанием выбранной СК

## (Этап-2, Шаг-5) Ожидание формирования ссылки на оплату / счета на оплату

Запускаем с интервалом в 1 сек вызовы ```GET``` ```/api/user/scoring/{scoringId}``` и ждем признака ```isPaymentInvoiceGenerated``` или ```isPaymentUrlGenerated``` == true (в зависимости от выбранного типа оплаты)

Если вернулось поле ```isFailed === true```, то произошла ошибка

Если оплата по карте, то ссылка на оплату будет в поле ```paymentLink```

Если оплата по счету, то нужно взять Ключ из поля ```paymentInvoiceDownloadKey``` и передать его в метод ```GET``` ```/download?key=XXX```

## (Этап-2, Шаг-6) Подтверждение оплаты с помощью подгрузки скана Платежного поручения (только для безналичной оплаты полиса)

Внимание! Данный шаг требуется выполнять только для полисов, оплачиваемых безналичной оплатой по счету!

После получения ПП об оплате его нужно загрузить в ```POST``` ```/api/blob``` и получить ```blobId```, потом передать в ```POST``` ```/api/user/scoring/{scoringId}/payment-order```

## (Этап-2, Шаг-7) Ожидание выпуска полиса и его скачивание

После оплаты (или загрузки ПП) запускаем с интервалом в 1 сек вызовы ```GET``` ```/api/user/scoring/{scoringId}``` и ждем флаг ```isPolicyIssued === true```, после чего скачиваем полис по ссылке ```policyLink```

## Сообщения об ошибках

В рамках процесса могут происходить ошибки (корректность введенных данных и т.д.).

Коды ошибок можно посмотреть тут https://github.com/MUST-Foundation/api-error-codes
