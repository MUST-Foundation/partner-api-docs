# Документация по использованию MUST Api для партнеров

В данном документе описан процесс взаимодействия с системой с целью выпуска полиса еОСАГО для грузовых ТС

Техническая документация Swagger доступна по адресу: https://api.must.io/swagger

## Схема взаимодействия

Взаимодействие с системой происходит через отправку асинхронных запросов в MUST Api и посредством отправки обратных уведомлений (хуков)

Внимание! В Swagger документации описаны контракты всех хуков. Однако в рабочей среде хуки с идентичными url и параметрами должны быть реализованы на стороне партнера. Хуки отправляются строго поочередно, и считаются переданными в случае ответа HTTP 200 OK. Если ответ будет иным, то система будет повторять попытки отправки хука до его получения.


## Основные шаги процесса

Для выпуска полиса необходимо пройти процесс от начала до конца. Каждый процесс имеет свой идентификатор (id)

Внимание! Шаг-3 и Шаг-4 погут происходить параллельно, или в независимой очередностью между друг другом. На запуск Шага-5 это влиять не будет. Однако выполять их надо не ранее завершения Шага-2

1. (Шаг-1) Авторизация в системе для каждого процесса
1. (Шаг-2) Инициация процесса
1. (Шаг-3) Загрузка документов
1. (Шаг-4) Формирование карточки договора страхования
1. (Шаг-5) Скоринг
1. (Шаг-6) Формирование ссылки на оплату
1. (Шаг-7) Выпуск и скачивание полиса

## (Шаг-1) Авторизация в системе

Для выполнения всех запросов к системе необходимо авторизоваться (получить токен). Токен действует в течение 7 суток. Для упрощения интеграции можно получать токен для каждого нового экземпляра процесса.

Метод: /api/scoring/auth

После получения токена его нужно передавать во всех последующих запросах в систему с помощью http-header

Пример ```Authorization: Bearer XXXXXX_TOKEN_XXXXXX```

## (Шаг-2) Инициация процесса 

Метод: /api/scoring/init

После инициации процесса система отправик хук /api/hooks/{scoringId}/documents/types-required


## (Шаг-3) Загрузка документов

Загрузка документов происходит в два этапа

1. Загрузка файлов в систему - метод /api/blob и получения их id
1. Ассоциация загруженных файлов с процессом - метод /api/scoring/{scoringId}/documents

Во время ассоциации документов система будет отправлять хуки /api/hooks/{scoringId}/documents/upload-failed, если загружены не все необходимые документы

После исправления всех ошибок, система отправит хук /api/hooks/{scoringId}/documents/upload-completed

## (Шаг-4) Формирование карточки договора страхования

Загрузка карточки договора страхования - метод /api/scoring/{scoringId}/contract

После успешной загрузки карточки договора страхования будет отправлен хук /api/hooks/{scoringId}/contract/update-completed

## (Шаг-5) Скоринг

Если этапы загрузки документов и формирования карточки договора страхования прошли успешно, то скоринг запустится автоматически

Система сформирует хук /api/hooks/{scoringId}/started при запуске скоринга

Когда скоринг завершится с результатом "Одобрено", то будет сформирован хук /api/hooks/{scoringId}/approved

Когда скоринг завершится с результатом "Отказ", то будет сформирован хук /api/hooks/{scoringId}/rejected

Процесс может двигаться дальше только, если результат скоринга - Одобрено

Так же будет сформирован хук /api/hooks/{scoringId}/draft-issued

## (Шаг-6) Формирование ссылки на оплату

После положительного скоринга необходимо запросить у системы ссылку на оплату полиса

Метод: /api/scoring/{scoringId}/payment-link

Когда ссылка на оплату будет сформирована, то система направит хук /api/hooks/{scoringId}/payment-link-generated

## (Шаг-7) Выпуск и скачивание полиса

После передачи ссылки на оплату система будет ожидать оплаты от страхователя. Когда оплата будет произведена, то система отправит хук /api/hooks/{scoringId}/policy-is-paid

После успешной оплаты система будет ожидать выпуск полиса со стороны СК и после отправит хук /api/hooks/{scoringId}/policy-issued

Документы можно скачать по ключу процесса и ключу файла с помощью метода /api/blob/{blobId}

## Сообщения об ошибках

В рамках процесса могут происходить ошибки (корректность введенных данных и т.д.).

Ошибки будут передаваться с помощью хука /api/hooks/{scoringId}/failed

Коды ошибок можно посмотреть тут https://github.com/MUST-Foundation/api-error-codes

## Вспомогательные методы

Для определения категориии ТС и обязательности использования прицепа можно использовать метод /api/scoring/vehicle/license-category

Для получения предварительного расчета стоимости (до подгрузки документов) можно использовать метод /api/scoring/tariff